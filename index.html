<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Tracker Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e293b;
            --primary-yellow: #fbbf24;
            --bg-light: #ffffff;
            --bg-dark: #0f172a;
            --text-light: #1f2937;
            --text-dark: #f8fafc;
            --border-light: #e5e7eb;
            --border-dark: #374151;
            --card-light: #f9fafb;
            --card-dark: #1e293b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="light"] {
            --bg-primary: var(--bg-light);
            --bg-secondary: var(--card-light);
            --text-primary: var(--text-light);
            --text-secondary: #6b7280;
            --border-color: var(--border-light);
        }

        [data-theme="dark"] {
            --bg-primary: var(--bg-dark);
            --bg-secondary: var(--card-dark);
            --text-primary: var(--text-dark);
            --text-secondary: #9ca3af;
            --border-color: var(--border-dark);
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
            margin-left: 1rem;
        }

        [data-theme="dark"] .logo {
            color: var(--primary-yellow);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-right: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        [data-theme="dark"] .btn-primary {
            background: var(--primary-yellow);
            color: var(--primary-blue);
        }

        .btn-primary:hover {
            background: #334155;
            transform: translateY(-1px);
        }

        [data-theme="dark"] .btn-primary:hover {
            background: #fde047;
            color: var(--primary-blue);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1);
        }

        [data-theme="dark"] .form-input:focus {
            outline: none;
            border-color: var(--primary-yellow);
            box-shadow: 0 0 0 3px rgba(253, 224, 71, 0.3);
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .tab-button {
            flex: 1;
            padding: 1rem;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: var(--primary-blue);
            color: white;
        }

        [data-theme="dark"] .tab-button.active {
            background: var(--primary-yellow);
            color: var(--primary-blue);
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .device-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .device-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .device-status.offline {
            background: var(--error);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .map-container {
            width: 100%;
            height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
        }

        .user-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .shared-users {
            margin-top: 1rem;
        }

        .shared-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .header {
                flex-direction: row;
                gap: 1rem;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 1rem;
                padding: 1rem;
            }

            .btn {
                min-height: 48px;
                padding: 0.75rem 1rem;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-blue);
        }

        [data-theme="dark"] .stat-number {
            color: var(--primary-yellow);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body data-theme="light">
    <div id="app">
        <!-- Header -->
        <div class="header">
            <div class="logo">🛰️ Car Tracker</div>
            <div class="header-controls">
                <button class="btn btn-secondary" onclick="toggleTheme()">🌙</button>
                <button class="btn btn-secondary" onclick="toggleLanguage()">🌐</button>
                <button id="logoutBtn" class="btn btn-secondary hidden" onclick="logout()">
                    <span data-lang="logout">Déconnexion</span>
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Authentication Forms -->
            <div id="authSection" class="auth-container">
                <div class="card">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showAuthForm('login')" data-lang="login">Connexion</button>
                        <button class="tab-button" onclick="showAuthForm('register')" data-lang="register">Inscription</button>
                    </div>

                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active">
                        <div class="form-group">
                            <label class="form-label" data-lang="email">Email</label>
                            <input type="email" class="form-input" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="password">Mot de passe</label>
                            <input type="password" class="form-input" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                            <span data-lang="login">Connexion</span>
                        </button>
                    </form>

                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form">
                        <div class="form-group">
                            <label class="form-label" data-lang="firstName">Prénom</label>
                            <input type="text" class="form-input" id="registerFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="lastName">Nom</label>
                            <input type="text" class="form-input" id="registerLastName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="phone">Téléphone</label>
                            <input type="tel" class="form-input" id="registerPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="email">Email</label>
                            <input type="email" class="form-input" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="password">Mot de passe</label>
                            <input type="password" class="form-input" id="registerPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-lang="confirmPassword">Confirmer le mot de passe</label>
                            <input type="password" class="form-input" id="registerConfirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                            <span data-lang="register">S'inscrire</span>
                        </button>
                    </form>

                    <!-- Email Verification -->
                    <div id="emailVerification" class="hidden">
                        <div class="alert alert-warning">
                            <span data-lang="emailVerificationSent">Un email de vérification a été envoyé. Veuillez vérifier votre boîte mail.</span>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="resendVerification()">
                            <span data-lang="resendEmail">Renvoyer l'email</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardSection" class="hidden">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDevices">0</div>
                        <div class="stat-label" data-lang="totalDevices">Dispositifs totaux</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="onlineDevices">0</div>
                        <div class="stat-label" data-lang="onlineDevices">En ligne</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sharedDevices">0</div>
                        <div class="stat-label" data-lang="sharedDevices">Partagés</div>
                    </div>
                </div>

                <!-- Add Device Button -->
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="showAddDeviceModal()">
                        ➕ <span data-lang="addDevice">Ajouter un dispositif</span>
                    </button>
                </div>

                <!-- Devices Grid -->
                <div class="devices-grid" id="devicesGrid">
                    <!-- Devices will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Add Device Modal -->
        <div id="addDeviceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-lang="addDevice">Ajouter un dispositif</h3>
                    <button class="close-btn" onclick="closeModal('addDeviceModal')">&times;</button>
                </div>
                <form id="addDeviceForm">
                    <div class="form-group">
                        <label class="form-label" data-lang="deviceId">ID du dispositif</label>
                        <input type="text" class="form-input" id="deviceId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-lang="deviceName">Nom du dispositif</label>
                        <input type="text" class="form-input" id="deviceName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-lang="devicePassword">Mot de passe du dispositif</label>
                        <input type="password" class="form-input" id="devicePassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <span data-lang="addDevice">Ajouter</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Device Access Modal -->
        <div id="deviceAccessModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-lang="deviceAccess">Accès au dispositif</h3>
                    <button class="close-btn" onclick="closeModal('deviceAccessModal')">&times;</button>
                </div>
                <form id="deviceAccessForm">
                    <div class="form-group">
                        <label class="form-label" data-lang="devicePassword">Mot de passe du dispositif</label>
                        <input type="password" class="form-input" id="accessPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <span data-lang="access">Accéder</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Device Management Modal -->
        <div id="deviceManagementModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="deviceManagementTitle">Gestion du dispositif</h3>
                    <button class="close-btn" onclick="closeModal('deviceManagementModal')">&times;</button>
                </div>
                
                <!-- Device Info -->
                <div class="card">
                    <h4 data-lang="deviceInfo">Informations du dispositif</h4>
                    <p><strong data-lang="deviceName">Nom:</strong> <span id="currentDeviceName"></span></p>
                    <p><strong data-lang="status">Statut:</strong> <span id="currentDeviceStatus"></span></p>
                    <p><strong data-lang="lastUpdate">Dernière mise à jour:</strong> <span id="currentDeviceLastUpdate"></span></p>
                </div>

                <!-- Current Position Map -->
                <div class="card">
                    <h4 data-lang="currentPosition">Position actuelle</h4>
                    <div class="map-container" id="deviceMap">
                        <span data-lang="mapPlaceholder">Carte GPS - Position: <span id="currentPosition">En attente...</span></span>
                    </div>
                </div>

                <!-- Position History -->
                <div class="card">
                    <h4 data-lang="positionHistory">Historique des positions</h4>
                    <div class="history-list" id="positionHistory">
                        <!-- History items will be loaded here -->
                    </div>
                </div>

                <!-- Device Actions (Owner only) -->
                <div class="card" id="ownerActions">
                    <h4 data-lang="deviceActions">Actions du dispositif</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn btn-warning" onclick="showChangePasswordModal()">
                            <span data-lang="changePassword">Changer le mot de passe</span>
                        </button>
                        <button class="btn btn-success" onclick="showShareDeviceModal()">
                            <span data-lang="shareDevice">Partager</span>
                        </button>
                        <button class="btn btn-secondary" onclick="showSharedUsersModal()">
                            <span data-lang="manageSharing">Gérer le partage</span>
                        </button>
                        <button class="btn btn-danger" onclick="removeDevice()">
                            <span data-lang="removeDevice">Supprimer</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="changePasswordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-lang="changePassword">Changer le mot de passe</h3>
                    <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
                </div>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label" data-lang="currentPassword">Mot de passe actuel</label>
                        <input type="password" class="form-input" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-lang="newPassword">Nouveau mot de passe</label>
                        <input type="password" class="form-input" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-lang="confirmNewPassword">Confirmer le nouveau mot de passe</label>
                        <input type="password" class="form-input" id="confirmNewPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <span data-lang="changePassword">Changer</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Share Device Modal -->
        <div id="shareDeviceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-lang="shareDevice">Partager le dispositif</h3>
                    <button class="close-btn" onclick="closeModal('shareDeviceModal')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label" data-lang="selectUser">Sélectionner un utilisateur</label>
                    <div class="user-list" id="userList">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Shared Users Management Modal -->
        <div id="sharedUsersModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-lang="manageSharing">Gérer le partage</h3>
                    <button class="close-btn" onclick="closeModal('sharedUsersModal')">&times;</button>
                </div>
                <div class="shared-users" id="sharedUsersList">
                    <!-- Shared users will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            fr: {
                login: "Connexion",
                register: "Inscription",
                email: "Email",
                password: "Mot de passe",
                firstName: "Prénom",
                lastName: "Nom",
                phone: "Téléphone",
                confirmPassword: "Confirmer le mot de passe",
                emailVerificationSent: "Un email de vérification a été envoyé. Veuillez vérifier votre boîte mail.",
                resendEmail: "Renvoyer l'email",
                logout: "Déconnexion",
                totalDevices: "Dispositifs totaux",
                onlineDevices: "En ligne",
                sharedDevices: "Partagés",
                addDevice: "Ajouter un dispositif",
                deviceId: "ID du dispositif",
                deviceName: "Nom du dispositif",
                devicePassword: "Mot de passe du dispositif",
                deviceAccess: "Accès au dispositif",
                access: "Accéder",
                deviceInfo: "Informations du dispositif",
                status: "Statut",
                lastUpdate: "Dernière mise à jour",
                currentPosition: "Position actuelle",
                mapPlaceholder: "Carte GPS - Position:",
                positionHistory: "Historique des positions",
                deviceActions: "Actions du dispositif",
                changePassword: "Changer le mot de passe",
                shareDevice: "Partager",
                manageSharing: "Gérer le partage",
                removeDevice: "Supprimer",
                currentPassword: "Mot de passe actuel",
                newPassword: "Nouveau mot de passe",
                confirmNewPassword: "Confirmer le nouveau mot de passe",
                selectUser: "Sélectionner un utilisateur",
                online: "En ligne",
                offline: "Hors ligne",
                owner: "Propriétaire",
                shared: "Partagé"
            },
            en: {
                login: "Login",
                register: "Register",
                email: "Email",
                password: "Password",
                firstName: "First Name",
                lastName: "Last Name",
                phone: "Phone",
                confirmPassword: "Confirm Password",
                emailVerificationSent: "A verification email has been sent. Please check your mailbox.",
                resendEmail: "Resend Email",
                logout: "Logout",
                totalDevices: "Total Devices",
                onlineDevices: "Online",
                sharedDevices: "Shared",
                addDevice: "Add Device",
                deviceId: "Device ID",
                deviceName: "Device Name",
                devicePassword: "Device Password",
                deviceAccess: "Device Access",
                access: "Access",
                deviceInfo: "Device Information",
                status: "Status",
                lastUpdate: "Last Update",
                currentPosition: "Current Position",
                mapPlaceholder: "GPS Map - Position:",
                positionHistory: "Position History",
                deviceActions: "Device Actions",
                changePassword: "Change Password",
                shareDevice: "Share",
                manageSharing: "Manage Sharing",
                removeDevice: "Remove",
                currentPassword: "Current Password",
                newPassword: "New Password",
                confirmNewPassword: "Confirm New Password",
                selectUser: "Select User",
                online: "Online",
                offline: "Offline",
                owner: "Owner",
                shared: "Shared"
            }
        };

        // Global state
        let currentUser = null;
        let currentDevice = null;
        let currentLanguage = 'fr';
        let currentTheme = 'light';

        // Firebase configuration (remplacez par vos vraies valeurs)
        const firebaseConfig = {
            apiKey: "AIzaSyDN5ebrGx-xWzRA4MSdnyGLn0K-UXNxok0",
            authDomain: "car-tracker-76b78.firebaseapp.com", 
            databaseURL: "https://car-tracker-76b78-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "car-tracker-76b78"
        };

        // Simple hash function for passwords
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // API calls to Firebase
        async function apiCall(endpoint, method = 'GET', data = null) {
            const url = `${firebaseConfig.databaseURL}/${endpoint}.json`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Show alert message
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Theme management
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        // Language management
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'fr' ? 'en' : 'fr';
            updateLanguage();
            localStorage.setItem('language', currentLanguage);
        }

        function updateLanguage() {
            const elements = document.querySelectorAll('[data-lang]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            document.documentElement.lang = currentLanguage;
        }

        // Authentication
        function showAuthForm(type) {
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`${type}Form`).classList.add('active');
            event.target.classList.add('active');
        }

        async function login(email, password) {
            try {
                const hashedPassword = await hashPassword(password);
                const users = await apiCall('users');
                
                if (users) {
                    const user = Object.values(users).find(u => 
                        u.email === email && u.hashedPassword === hashedPassword
                    );
                    
                    if (user && user.emailVerified) {
                        currentUser = user;
                        showDashboard();
                        return true;
                    }
                }
                
                throw new Error('Invalid credentials or email not verified');
            } catch (error) {
                showAlert('Login failed: ' + error.message, 'error');
                return false;
            }
        }

        async function register(userData) {
            try {
                const hashedPassword = await hashPassword(userData.password);
                const userId = generateId();
                
                const user = {
                    id: userId,
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    phone: userData.phone,
                    email: userData.email,
                    hashedPassword: hashedPassword,
                    emailVerified: false,
                    createdAt: new Date().toISOString()
                };

                await apiCall(`users/${userId}`, 'PUT', user);
                
                // Simulate email verification (in real implementation, send actual email)
                showEmailVerification(userData.email);
                return true;
            } catch (error) {
                showAlert('Registration failed: ' + error.message, 'error');
                return false;
            }
        }

        function showEmailVerification(email) {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('emailVerification').classList.remove('hidden');
            
            // Simulate email verification after 3 seconds
            setTimeout(() => {
                simulateEmailVerification(email);
            }, 3000);
        }

        async function simulateEmailVerification(email) {
            try {
                const users = await apiCall('users');
                if (users) {
                    const userEntry = Object.entries(users).find(([id, user]) => user.email === email);
                    if (userEntry) {
                        const [userId, user] = userEntry;
                        user.emailVerified = true;
                        await apiCall(`users/${userId}`, 'PUT', user);
                        
                        showAlert('Email verified successfully! You can now login.', 'success');
                        document.getElementById('emailVerification').classList.add('hidden');
                        showAuthForm('login');
                    }
                }
            } catch (error) {
                showAlert('Email verification failed', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentDevice = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            loadUserDevices();
        }

        // Device management
        async function loadUserDevices() {
            try {
                const devices = await apiCall('devices');
                const userDevices = [];
                
                if (devices) {
                    Object.values(devices).forEach(device => {
                        if (device.ownerId === currentUser.id || 
                            (device.sharedWith && device.sharedWith.includes(currentUser.id))) {
                            userDevices.push(device);
                        }
                    });
                }
                
                updateDeviceStats(userDevices);
                renderDevices(userDevices);
            } catch (error) {
                showAlert('Failed to load devices', 'error');
            }
        }

        function updateDeviceStats(devices) {
            const totalDevices = devices.length;
            const onlineDevices = devices.filter(d => d.status === 'online').length;
            const sharedDevices = devices.filter(d => d.ownerId !== currentUser.id).length;
            
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('onlineDevices').textContent = onlineDevices;
            document.getElementById('sharedDevices').textContent = sharedDevices;
        }

        function renderDevices(devices) {
            const grid = document.getElementById('devicesGrid');
            grid.innerHTML = '';
            
            devices.forEach(device => {
                const isOwner = device.ownerId === currentUser.id;
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                deviceCard.onclick = () => showDeviceAccessModal(device);
                
                deviceCard.innerHTML = `
                    <div class="device-status ${device.status === 'online' ? '' : 'offline'}"></div>
                    <h3>${device.name}</h3>
                    <p><strong>${translations[currentLanguage].status}:</strong> ${translations[currentLanguage][device.status || 'offline']}</p>
                    <p><strong>ID:</strong> ${device.id}</p>
                    <p><strong>${translations[currentLanguage].owner}:</strong> ${isOwner ? translations[currentLanguage].owner : translations[currentLanguage].shared}</p>
                    ${device.lastPosition ? `<p><strong>${translations[currentLanguage].lastUpdate}:</strong> ${new Date(device.lastPosition.timestamp).toLocaleString()}</p>` : ''}
                `;
                
                grid.appendChild(deviceCard);
            });
        }

        async function addDevice(deviceData) {
            try {
                // Check if device exists
                const devices = await apiCall('devices');
                let existingDevice = null;
                
                if (devices) {
                    existingDevice = Object.values(devices).find(d => d.id === deviceData.id);
                }
                
                if (!existingDevice) {
                    throw new Error('Device not found');
                }
                
                if (existingDevice.ownerId) {
                    throw new Error('Device already has an owner');
                }
                
                // Update device with owner and password
                const hashedPassword = await hashPassword(deviceData.password);
                existingDevice.ownerId = currentUser.id;
                existingDevice.name = deviceData.name;
                existingDevice.hashedPassword = hashedPassword;
                existingDevice.sharedWith = [];
                
                const deviceKey = Object.keys(devices).find(key => devices[key].id === deviceData.id);
                await apiCall(`devices/${deviceKey}`, 'PUT', existingDevice);
                
                showAlert('Device added successfully!', 'success');
                closeModal('addDeviceModal');
                loadUserDevices();
                return true;
            } catch (error) {
                showAlert('Failed to add device: ' + error.message, 'error');
                return false;
            }
        }

        function showDeviceAccessModal(device) {
            currentDevice = device;
            document.getElementById('deviceAccessModal').classList.add('active');
        }

        async function accessDevice(password) {
            try {
                const hashedPassword = await hashPassword(password);
                
                if (currentDevice.hashedPassword === hashedPassword) {
                    closeModal('deviceAccessModal');
                    showDeviceManagement();
                    return true;
                } else {
                    throw new Error('Invalid password');
                }
            } catch (error) {
                showAlert('Access denied: ' + error.message, 'error');
                return false;
            }
        }

        async function showDeviceManagement() {
            document.getElementById('deviceManagementModal').classList.add('active');
            document.getElementById('currentDeviceName').textContent = currentDevice.name;
            document.getElementById('currentDeviceStatus').textContent = translations[currentLanguage][currentDevice.status || 'offline'];
            
            if (currentDevice.lastPosition) {
                document.getElementById('currentDeviceLastUpdate').textContent = 
                    new Date(currentDevice.lastPosition.timestamp).toLocaleString();
                document.getElementById('currentPosition').textContent = 
                    `${currentDevice.lastPosition.latitude}, ${currentDevice.lastPosition.longitude}`;
            }
            
            // Show/hide owner actions
            const isOwner = currentDevice.ownerId === currentUser.id;
            document.getElementById('ownerActions').style.display = isOwner ? 'block' : 'none';
            
            // Load position history
            await loadPositionHistory();
        }

        async function loadPositionHistory() {
            try {
                const positions = await apiCall(`devicePositions/${currentDevice.id}`);
                const historyContainer = document.getElementById('positionHistory');
                historyContainer.innerHTML = '';
                
                if (positions) {
                    const positionArray = Object.values(positions).sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    
                    positionArray.forEach(position => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <div>
                                <strong>${position.latitude}, ${position.longitude}</strong>
                            </div>
                            <div>
                                ${new Date(position.timestamp).toLocaleString()}
                            </div>
                        `;
                        historyContainer.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('Failed to load position history:', error);
            }
        }

        // Modal management
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            await login(email, password);
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            const userData = {
                firstName: document.getElementById('registerFirstName').value,
                lastName: document.getElementById('registerLastName').value,
                phone: document.getElementById('registerPhone').value,
                email: document.getElementById('registerEmail').value,
                password: password
            };
            
            await register(userData);
        });

        document.getElementById('addDeviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const deviceData = {
                id: document.getElementById('deviceId').value,
                name: document.getElementById('deviceName').value,
                password: document.getElementById('devicePassword').value
            };
            await addDevice(deviceData);
        });

        document.getElementById('deviceAccessForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('accessPassword').value;
            await accessDevice(password);
        });

        // Initialize app
        function initApp() {
            // Load saved preferences
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedLanguage = localStorage.getItem('language') || 'fr';
            
            currentTheme = savedTheme;
            currentLanguage = savedLanguage;
            
            document.body.setAttribute('data-theme', currentTheme);
            updateLanguage();
            
            // Auto dark mode detection
            if (!localStorage.getItem('theme')) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    currentTheme = 'dark';
                    document.body.setAttribute('data-theme', 'dark');
                }
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!localStorage.getItem('theme')) {
                    currentTheme = event.matches ? 'dark' : 'light';
                    document.body.setAttribute('data-theme', currentTheme);
                }
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // Device ID generation and initialization
        function generateDeviceId() {
            // Format: GPS-XXXX-YYYY (ex: GPS-2025-1A2B)
            const year = new Date().getFullYear();
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `GPS-${year}-${random}`;
        }

        // Initialize database with sample devices (run this once)
        async function initializeDatabase() {
            try {
                // Create 5 sample devices
                const sampleDevices = [];
                for (let i = 0; i < 5; i++) {
                    const deviceId = generateDeviceId();
                    const device = {
                        id: deviceId,
                        name: null,
                        ownerId: null,
                        hashedPassword: null,
                        sharedWith: [],
                        status: 'offline',
                        createdAt: new Date().toISOString(),
                        lastPosition: null
                    };
                    sampleDevices.push(device);
                    
                    // Add to Firebase
                    await apiCall(`devices/${deviceId}`, 'PUT', device);
                    console.log(`Created device: ${deviceId}`);
                }
                
                showAlert(`${sampleDevices.length} sample devices created successfully!`, 'success');
                return sampleDevices;
            } catch (error) {
                console.error('Failed to initialize database:', error);
                showAlert('Failed to initialize database: ' + error.message, 'error');
            }
        }

        // Function to add a single device to database (for ESP32 to call)
        async function createDevice(deviceId = null) {
            try {
                const id = deviceId || generateDeviceId();
                const device = {
                    id: id,
                    name: null,
                    ownerId: null,
                    hashedPassword: null,
                    sharedWith: [],
                    status: 'offline',
                    createdAt: new Date().toISOString(),
                    lastPosition: null
                };
                
                await apiCall(`devices/${id}`, 'PUT', device);
                console.log(`Device created: ${id}`);
                return device;
            } catch (error) {
                console.error('Failed to create device:', error);
                throw error;
            }
        }

        // Function to update device position (for ESP32 to call)
        async function updateDevicePosition(deviceId, latitude, longitude) {
            try {
                const timestamp = new Date().toISOString();
                const position = {
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: timestamp
                };
                
                // Update device's last position
                const devices = await apiCall('devices');
                if (devices) {
                    const deviceKey = Object.keys(devices).find(key => devices[key].id === deviceId);
                    if (deviceKey) {
                        const device = devices[deviceKey];
                        device.lastPosition = position;
                        device.status = 'online';
                        await apiCall(`devices/${deviceKey}`, 'PUT', device);
                    }
                }
                
                // Add to position history
                const positionId = generateId();
                await apiCall(`devicePositions/${deviceId}/${positionId}`, 'PUT', position);
                
                console.log(`Position updated for device ${deviceId}: ${latitude}, ${longitude}`);
                return position;
            } catch (error) {
                console.error('Failed to update position:', error);
                throw error;
            }
        }

        // Admin function to view all devices (for debugging)
        async function listAllDevices() {
            try {
                const devices = await apiCall('devices');
                console.log('All devices:', devices);
                return devices;
            } catch (error) {
                console.error('Failed to list devices:', error);
            }
        }

        // Add admin panel button (for testing only)
        function addAdminPanel() {
            const adminBtn = document.createElement('button');
            adminBtn.textContent = '🔧 Admin';
            adminBtn.className = 'btn btn-secondary';
            adminBtn.onclick = showAdminPanel;
            document.querySelector('.header-controls').insertBefore(adminBtn, document.getElementById('logoutBtn'));
        }

        function showAdminPanel() {
            const actions = `
                <button onclick="initializeDatabase()" class="btn btn-primary">Initialize Sample Devices</button>
                <button onclick="listAllDevices()" class="btn btn-secondary">List All Devices</button>
                <button onclick="testPositionUpdate()" class="btn btn-warning">Test Position Update</button>
            `;
            
            const adminDiv = document.createElement('div');
            adminDiv.innerHTML = `
                <div class="card">
                    <h3>Admin Panel (Debug)</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${actions}
                    </div>
                </div>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(adminDiv, container.firstChild);
            
            // Remove after 10 seconds
            setTimeout(() => adminDiv.remove(), 10000);
        }

        async function testPositionUpdate() {
            try {
                const devices = await apiCall('devices');
                if (devices) {
                    const deviceList = Object.values(devices);
                    if (deviceList.length > 0) {
                        const randomDevice = deviceList[0];
                        // Simulate position in Yaoundé, Cameroon
                        const lat = 3.848 + (Math.random() - 0.5) * 0.01;
                        const lng = 11.502 + (Math.random() - 0.5) * 0.01;
                        
                        await updateDevicePosition(randomDevice.id, lat, lng);
                        showAlert(`Position updated for ${randomDevice.id}`, 'success');
                    }
                }
            } catch (error) {
                showAlert('Failed to test position update', 'error');
            }
        }

        // Start the app
        initApp();
        
        // Add admin panel in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '192.168.4.1') {
            addAdminPanel();
        }
    </script>
</body>
</html>